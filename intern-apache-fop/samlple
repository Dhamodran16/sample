<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
                xmlns:fo="http://www.w3.org/1999/XSL/Format"
                version="1.0">
  <xsl:param name="logofile" select="'logo.png'"/>
  <xsl:param name="securityHeader" select="'SECURITY HEADER'"/>
  <xsl:param name="addInfoVar" select="'Additional Info'"/>
  <xsl:param name="pmc" select="'PMC CODE'"/>
  <xsl:param name="printTime" select="'Print Time'"/>
  <xsl:param name="inworkInfo" select="'In Work'"/>

  <xsl:param name="dmApplicVar" select="'Applicability text'"/>
  <xsl:param name="dmcIssnoLabelVar" select="'DMC/ISSNO label'"/>
  <xsl:param name="proprietaryTextVar" select="'Proprietary text'"/>
  <xsl:param name="endLabelPostfix" select="'END LABEL'"/>
  <xsl:param name="securityFooter" select="'SECURITY FOOTER'"/>
  
<xsl:param name="dmDmCodeStringVar" select="'DMC CODE'"/>
  <xsl:param name="pnrtype" select="'ARABIC'"/>
  <xsl:param name="dmIssueDateYear" select="'0000'"/>
  <xsl:param name="dmIssueDateMonth" select="'00'"/>
  <xsl:param name="dmIssueDateDay" select="'00'"/>
  <xsl:param name="descTextVar" select="'Description'"/>
  <xsl:param name="procedTextVar" select="'Procedure'"/>
  <xsl:param name="dmDmc" select="''"/>
  <xsl:param name="titlePageImage" select="'titlepage-image.png'"/>
  <xsl:param name="manufacturerLogo" select="'manufacturer-logo.png'"/>
  <xsl:param name="manufacturerAddress" select="'Manufacturer address goes here'"/>
  <xsl:param name="renderTitlePage" select="'false'"/>
  <xsl:param name="pageMaster" select="'simpleA4'"/>

  <xsl:template match="/">
    <fo:root>
      <fo:layout-master-set>

         <fo:simple-page-master master-name="simpleA4"
                               page-width="210mm" page-height="297mm"
                               margin-left="25mm" margin-right="15mm"
                               margin-top="33mm" margin-bottom="30mm">
  
         <fo:region-body margin-top="33mm" margin-bottom="30mm"/>
          <fo:region-before extent="30mm"/>
          <fo:region-after extent="30mm"/>
        </fo:simple-page-master>

        <fo:simple-page-master master-name="crewRightA4"
                               page-width="210mm" page-height="297mm"
       
                        margin-left="25mm" margin-right="15mm"
                               margin-top="33mm" margin-bottom="30mm">
          <fo:region-body margin-top="33mm" margin-bottom="30mm"/>
          <fo:region-before extent="30mm"/>
          <fo:region-after extent="30mm"/>
        </fo:simple-page-master>

 
       <fo:simple-page-master master-name="crewLeftA4"
                               page-width="210mm" page-height="297mm"
                               margin-left="25mm" margin-right="15mm"
                
               margin-top="33mm" margin-bottom="30mm">
          <fo:region-body margin-top="33mm" margin-bottom="30mm"/>
          <fo:region-before extent="30mm"/>
          <fo:region-after extent="30mm"/>
        </fo:simple-page-master>

        <fo:simple-page-master master-name="ipdFirstA4"
                     
          page-width="210mm" page-height="297mm"
                               margin-left="25mm" margin-right="15mm"
                               margin-top="33mm" margin-bottom="30mm">
          <fo:region-body margin-top="33mm" margin-bottom="30mm"/>
          <fo:region-before extent="30mm"/>
          <fo:region-after extent="30mm"/>
        </fo:simple-page-master>

        <fo:simple-page-master master-name="titleA4"
                               page-width="210mm" page-height="297mm"
                              
 margin-left="25mm" margin-right="15mm"
                               margin-top="33mm" margin-bottom="30mm">
          <fo:region-body margin-top="33mm" margin-bottom="30mm"/>
          <fo:region-before extent="30mm"/>
          <fo:region-after extent="30mm"/>
        </fo:simple-page-master>

        <fo:simple-page-master master-name="foldoutA3"
    
                           page-width="420mm" page-height="297mm"
                               margin-left="25mm" margin-right="15mm"
                               margin-top="33mm" margin-bottom="31mm">
        
  <fo:region-body margin-top="33mm" margin-bottom="30mm"/>
          <fo:region-before extent="30mm"/>
          <fo:region-after extent="30mm"/>
        </fo:simple-page-master>

        <fo:simple-page-master master-name="simpleLetterRight"
                               page-width="215.9mm" page-height="279.4mm"
             
                  margin-left="30mm" margin-right="15mm"
                               margin-top="25mm" margin-bottom="22mm">
          <fo:region-body margin-top="33mm" margin-bottom="30mm"/>
          <fo:region-before extent="23mm"/>
          <fo:region-after extent="22mm"/>
        </fo:simple-page-master>

       
 <fo:simple-page-master master-name="simpleLetterLeft"
                               page-width="215.9mm" page-height="279.4mm"
                               margin-left="16mm" margin-right="29.9mm"
                      
         margin-top="25mm" margin-bottom="22mm">
          <fo:region-body margin-top="33mm" margin-bottom="30mm"/>
          <fo:region-before extent="23mm"/>
          <fo:region-after extent="22mm"/>
        </fo:simple-page-master>

        <fo:simple-page-master master-name="ipdFirstLetterRight"
                           
    page-width="215.9mm" page-height="279.4mm"
                               margin-left="30mm" margin-right="15mm"
                               margin-top="25mm" margin-bottom="22mm">
          <fo:region-body margin-top="33mm" margin-bottom="30mm"/>
          <fo:region-before extent="23mm"/>
          <fo:region-after extent="22mm"/>
        </fo:simple-page-master>

        <fo:simple-page-master master-name="ipdSimpleLetterRight"
                               page-width="215.9mm" page-height="279.4mm"
                               margin-left="30mm" margin-right="15mm"
   
                            margin-top="25mm" margin-bottom="22mm">
          <fo:region-body margin-top="33mm" margin-bottom="30mm"/>
          <fo:region-before extent="23mm"/>
          <fo:region-after extent="22mm"/>
        </fo:simple-page-master>

        <fo:simple-page-master master-name="ipdSimpleLetterLeft"
       
                        page-width="215.9mm" page-height="279.4mm"
                               margin-left="16mm" margin-right="29.9mm"
                               margin-top="25mm" margin-bottom="22mm">
          <fo:region-body margin-top="33mm" margin-bottom="30mm"/>
        <fo:region-before extent="23mm"/>
          <fo:region-after extent="22mm"/>
        </fo:simple-page-master>

        <fo:simple-page-master master-name="foldoutLetter"
                               page-width="431.8mm" page-height="279.4mm"
                 
              margin-left="30mm" margin-right="15mm"
                               margin-top="25mm" margin-bottom="22mm">
          <fo:region-body margin-top="33mm" margin-bottom="30mm"/>
          <fo:region-before extent="23mm"/>
          <fo:region-after extent="22mm"/>
        </fo:simple-page-master>

      </fo:layout-master-set>

     
 <fo:bookmark-tree>
        <xsl:if test="//description">
          <fo:bookmark internal-destination="description">
            <fo:bookmark-title><xsl:value-of select="$descTextVar"/></fo:bookmark-title>
          </fo:bookmark>
        </xsl:if>
        <xsl:if test="//mainProcedure">
          <fo:bookmark internal-destination="mainProc">
            <fo:bookmark-title><xsl:value-of select="$procedTextVar"/></fo:bookmark-title>
      
    </fo:bookmark>
        </xsl:if>
        <xsl:for-each select="//proceduralStep[title]">
          <fo:bookmark>
            <xsl:attribute name="internal-destination">
              <xsl:text>step-</xsl:text>
              <xsl:number level="multiple" count="proceduralStep" format="1.1.1.1"/>
            </xsl:attribute>
            <fo:bookmark-title>
 
             <xsl:number level="multiple" count="proceduralStep" format="1.1.1.1"/>
              <xsl:text> </xsl:text>
              <xsl:value-of select="normalize-space(title)"/>
            </fo:bookmark-title>
          </fo:bookmark>
        </xsl:for-each>
      </fo:bookmark-tree>

      <xsl:if test="$renderTitlePage='true'">
 
       <fo:page-sequence master-reference="titleA4"
                          font-family="Helvetica" font-size="10pt" line-height="12pt"
                          hyphenate="true">
          <fo:static-content flow-name="xsl-region-before">
            <fo:block>
              <fo:table 
table-layout="fixed" width="169mm" border-bottom="1pt solid #000">
                <fo:table-column column-width="50mm"/>
                <fo:table-column column-width="70mm"/>
                <fo:table-column column-width="50mm"/>
                <fo:table-body>
                  <fo:table-row>
           
         <fo:table-cell>
                      <fo:block text-align="left">
                        <fo:external-graphic src="url({$logofile})" content-width="scale-to-fit" width="50mm" height="17mm"/>
                      </fo:block>
                  
  </fo:table-cell>
                    <fo:table-cell>
                      <fo:block font-family="Helvetica" font-weight="bold" font-size="11pt" text-align="center">
                        <xsl:value-of select="$securityHeader"/>
                      </fo:block>
     
               </fo:table-cell>
                    <fo:table-cell>
                      <fo:block font-family="Helvetica" font-weight="bold" font-size="11pt" text-align="right">
                        <xsl:value-of select="$pmc"/>
              
        </fo:block>
                    </fo:table-cell>
                  </fo:table-row>
                </fo:table-body>
              </fo:table>
            </fo:block>
          </fo:static-content>

  
        <fo:static-content flow-name="xsl-region-after">
            <fo:block>
              <fo:table table-layout="fixed" width="169mm" border-top="1pt solid #000">
                <fo:table-column column-width="60mm"/>
                <fo:table-column column-width="50mm"/>
                <fo:table-column column-width="60mm"/>
         
       <fo:table-body>
                  <fo:table-row>
                    <fo:table-cell>
                      <fo:block font-size="10pt" line-height="11pt">
                        <xsl:value-of select="$dmApplicVar"/>
      
                </fo:block>
                      <fo:block font-size="6pt" space-before="6pt">
                        <fo:inline font-style="italic"><xsl:value-of select="$dmcIssnoLabelVar"/></fo:inline>
                      </fo:block>
            
        </fo:table-cell>
                    <fo:table-cell>
                      <fo:block font-family="Helvetica" font-weight="bold" text-align="center">
                        <xsl:value-of select="$securityFooter"/>
                      
</fo:block>
                    </fo:table-cell>
                    <fo:table-cell>
                      <fo:block text-align="right" font-family="Helvetica" font-weight="bold">
                        <xsl:value-of select="$dmDmCodeStringVar"/>
          
            </fo:block>
                      <fo:block text-align="right" font-family="Helvetica" font-weight="bold" space-before="6pt">
                        <xsl:value-of select="concat($dmIssueDateYear,'-',$dmIssueDateMonth,'-',$dmIssueDateDay)"/>
                        <xsl:text>  Page </xsl:text><fo:page-number/>
          
            </fo:block>
                    </fo:table-cell>
                  </fo:table-row>
                  <fo:table-row>
                    <fo:table-cell number-columns-spanned="3">
           
           <fo:block text-align="center" font-family="Helvetica" font-weight="bold" font-size="11pt" space-before="2mm">
                        <xsl:value-of select="$endLabelPostfix"/>
                      </fo:block>
                    </fo:table-cell>
                 
 </fo:table-row>
                </fo:table-body>
              </fo:table>
            </fo:block>
          </fo:static-content>

          <fo:flow flow-name="xsl-region-body">
            <fo:block-container absolute-position="absolute" top="130mm" left="0mm" width="169mm" height="65mm">
   
           <fo:block text-align="center">
                <fo:external-graphic src="url({$titlePageImage})" content-width="scale-to-fit" content-height="scale-to-fit" width="169mm" height="65mm"/>
              </fo:block>
            </fo:block-container>

            <fo:block space-before="155mm" font-family="Helvetica" font-size="7pt" line-height="10pt">
        
      <xsl:value-of select="$proprietaryTextVar"/>
            </fo:block>

            <fo:block border-top="1pt solid #000" space-before="2mm"/>
            <fo:table table-layout="fixed" width="169mm">
              <fo:table-column column-width="45mm"/>
              <fo:table-column column-width="125mm"/>
              <fo:table-body>
       
         <fo:table-row>
                  <fo:table-cell>
                    <fo:block font-family="Helvetica" font-size="8pt">Manufacturer:</fo:block>
                    <fo:block>
                      <fo:external-graphic src="url({$manufacturerLogo})" content-width="scale-to-fit" width="45mm" height="12mm"/>
     
               </fo:block>
                  </fo:table-cell>
                  <fo:table-cell>
                    <fo:block><xsl:value-of select="$manufacturerAddress"/></fo:block>
                  </fo:table-cell>
          
      </fo:table-row>
              </fo:table-body>
            </fo:table>
            <fo:block border-top="1pt solid #000" space-before="2mm"/>
          </fo:flow>
        </fo:page-sequence>
      </xsl:if>

      <fo:page-sequence master-reference="{$pageMaster}"
            
            font-family="Helvetica" font-size="10pt" line-height="12pt"
                        hyphenate="true">
        <fo:static-content flow-name="xsl-region-before">
          <fo:block>
            <fo:table table-layout="fixed" width="169mm" border-bottom="1pt solid #000">
              <fo:table-column column-width="50mm"/>
           
   <fo:table-column column-width="70mm"/>
              <fo:table-column column-width="50mm"/>
              <fo:table-body>
                <fo:table-row>
                  <fo:table-cell>
                    <fo:block text-align="left">
            
          <fo:external-graphic src="url({$logofile})" content-width="scale-to-fit" width="50mm" height="17mm"/>
                    </fo:block>
                  </fo:table-cell>
                  <fo:table-cell>
                    <fo:block font-family="Helvetica" font-weight="bold" font-size="11pt" text-align="center">
      
                <xsl:value-of select="$securityHeader"/>
                    </fo:block>
                    <fo:block font-family="Helvetica" font-weight="bold" font-size="11pt" text-align="center">
                      <xsl:value-of select="$addInfoVar"/>
                
    </fo:block>
                  </fo:table-cell>
                  <fo:table-cell>
                    <fo:block font-family="Helvetica" font-weight="bold" font-size="11pt" text-align="right">
                      <xsl:value-of select="$pmc"/>
             
       </fo:block>
                  </fo:table-cell>
                </fo:table-row>
              </fo:table-body>
            </fo:table>
          </fo:block>
        </fo:static-content>

        <fo:static-content flow-name="xsl-region-after">
      
    <fo:block>
            <fo:table table-layout="fixed" width="169mm" border-top="1pt solid #000">
              <fo:table-column column-width="60mm"/>
              <fo:table-column column-width="50mm"/>
              <fo:table-column column-width="60mm"/>
              <fo:table-body>
                <fo:table-row>
    
              <fo:table-cell>
                    <fo:block font-size="10pt" line-height="11pt">
                      <xsl:value-of select="$dmApplicVar"/>
                    </fo:block>
                    <fo:block 
font-size="6pt" space-before="6pt">
                      <fo:inline font-style="italic"><xsl:value-of select="$dmcIssnoLabelVar"/></fo:inline>
                    </fo:block>
                    <fo:block font-size="10pt" space-before="2mm">
                      <xsl:value-of select="$proprietaryTextVar"/>
          
          </fo:block>
                  </fo:table-cell>
                  <fo:table-cell>
                    <fo:block text-align="center" font-family="Helvetica" font-weight="bold">
                      <xsl:value-of select="$securityFooter"/>
        
            </fo:block>
                  </fo:table-cell>
                  <fo:table-cell>
                    <fo:block text-align="right" font-family="Helvetica" font-weight="bold">
                      <xsl:value-of select="$dmDmCodeStringVar"/>
      
              </fo:block>
                    <fo:block text-align="right" font-family="Helvetica" font-weight="bold" space-before="6pt">
                      <xsl:value-of select="concat($dmIssueDateYear,'-',$dmIssueDateMonth,'-',$dmIssueDateDay)"/>
                      <xsl:text>  Page </xsl:text><fo:page-number/>
              
      </fo:block>
                  </fo:table-cell>
                </fo:table-row>
                <fo:table-row>
                  <fo:table-cell number-columns-spanned="3">
                    <fo:block text-align="center" font-family="Helvetica" font-weight="bold" font-size="11pt" 
space-before="2mm">
                      <xsl:value-of select="$endLabelPostfix"/>
                    </fo:block>
                  </fo:table-cell>
                </fo:table-row>
              </fo:table-body>
         
   </fo:table>
          </fo:block>
        </fo:static-content>

        <fo:flow flow-name="xsl-region-body">
          <xsl:apply-templates select="//description |
//mainProcedure"/>

          <xsl:if test="not(//description)">
            <fo:block id="description" space-before="12pt">
              <fo:block font-family="Helvetica" font-weight="bold" font-size="10pt" keep-with-next.within-page="always">
                <xsl:value-of select="$descTextVar"/>
              </fo:block>
      
      </fo:block>
          </xsl:if>
          <xsl:if test="not(//mainProcedure)">
            <fo:block id="mainProc" space-before="28pt" space-after="28pt">
              <fo:block font-family="Helvetica" font-weight="bold" font-size="10pt" keep-with-next.within-page="always">
                <xsl:value-of select="$procedTextVar"/>
              </fo:block>
         
   </fo:block>
          </xsl:if>

          <xsl:apply-templates select="//proceduralStep"/>
        </fo:flow>
      </fo:page-sequence>

    </fo:root>
  </xsl:template>

  <xsl:template match="*[@id]" mode="id-attr">
    <xsl:attribute name="id">
      <xsl:value-of select="concat($dmDmc, @id)"/>
    </xsl:attribute>
  </xsl:template>

  <xsl:template match="description">
 
   <fo:block space-before="12pt">
      <fo:block id="description" font-family="Helvetica" font-weight="bold" font-size="10pt" keep-with-next.within-page="always">
        <xsl:value-of select="$descTextVar"/>
      </fo:block>
      <xsl:apply-templates/>
    </fo:block>
  </xsl:template>

  <xsl:template match="mainProcedure">
    <fo:block id="mainProc" space-before="28pt" space-after="28pt">
      <fo:block font-family="Helvetica" font-weight="bold" font-size="10pt" keep-with-next.within-page="always">
        <xsl:value-of select="$procedTextVar"/>
      </fo:block>
   
   <xsl:apply-templates/>
    </fo:block>
  </xsl:template>

  <xsl:template match="proceduralStep">
    <fo:block space-after="14pt">
      <xsl:variable name="level" select="count(ancestor::proceduralStep) + 1"/>
      <fo:block keep-with-next.within-page="always">
        <xsl:attribute name="font-family">Helvetica</xsl:attribute>
        <xsl:choose>
          <xsl:when test="$level = 1">
            <xsl:attribute name="font-size">14pt</xsl:attribute>
      
      <xsl:attribute name="line-height">16pt</xsl:attribute>
          </xsl:when>
          <xsl:when test="$level = 2">
            <xsl:attribute name="font-size">12pt</xsl:attribute>
            <xsl:attribute name="line-height">14pt</xsl:attribute>
          </xsl:when>
          <xsl:otherwise>
            <xsl:if test="$level &gt;
4">
              <xsl:attribute name="font-style">oblique</xsl:attribute>
            </xsl:if>
            <xsl:attribute name="font-size">10pt</xsl:attribute>
            <xsl:attribute name="line-height">12pt</xsl:attribute>
          </xsl:otherwise>
        </xsl:choose>
        <xsl:attribute name="id">
          <xsl:text>step-</xsl:text>
          
<xsl:number level="multiple" count="proceduralStep" format="1.1.1.1"/>
        </xsl:attribute>
        <xsl:number level="multiple" count="proceduralStep" format="1.1.1.1"/>
        <xsl:text> </xsl:text>
        <xsl:value-of select="normalize-space(title)"/>
      </fo:block>
      <xsl:apply-templates select="node()[not(self::title)]"/>
    </fo:block>
  </xsl:template>

  <xsl:template match="para|p|text()">
    <fo:block><xsl:value-of select="normalize-space(.)"/></fo:block>
  </xsl:template>

  <xsl:template match="*">
    <xsl:apply-templates/>
  </xsl:template>

</xsl:stylesheet>
